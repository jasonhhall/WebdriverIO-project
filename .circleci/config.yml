version: 2.1

jobs:
  test:
    docker:
      - image: twitchautomation/salesforce-cx-repo:latest
    steps:
      - checkout
      - run: apt-get update && apt-get install -y \software-properties-common

      # Add the "JAVA" ppa
      - run: RUN add-apt-repository -y \ppa:webupd8team/java

      # Install OpenJDK-8
      - run: apt-get update && \
          apt-get install -y openjdk-8-jdk && \
          apt-get install -y ant && \
          apt-get clean;

      - run: apt-get update && \
          apt-get install ca-certificates-java && \
          apt-get clean && \update-ca-certificates -f;

      # Setup JAVA_HOME -- useful for docker commandline
      - env: JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64/
      - run:  export JAVA_HOME
      - run:
          name: install packages
          command: npm install
      - run:
          name: Run Test
          command: yarn run test-remote
      - run:
          name: generate allure report
          command: |
            npm install -g allure-commandline
            echo BRANCH=development >> allure-results/environment.properties
            echo COMMIT=$CI_PULL_REQUEST/commits/$CIRCLE_SHA1 >> allure-results/environment.properties
            allure generate --clean
          when: always
      - store_artifacts:
          path: /home/circleci/project/allure-report
     
workflows:
  orb-free-workflow:
    jobs:
      - test
